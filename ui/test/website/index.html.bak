<!DOCTYPE html>
<html dir="ltr" lang="en">
  <head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type">
    <title>TableMiner+</title>
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>      
      var socket=io();

      var items=[]
      $(document).ready(function() {
        var tableParserSelect = document.getElementById('tableparser');
        socket.on('filltableparseroptions', function(data){
            var tableParserOptions = data.options;
            $.each( tableParserOptions, function( key, val ) {
              option = document.createElement('option');
              option.setAttribute('value', key);
              option.appendChild(document.createTextNode(val));
              tableParserSelect.appendChild(option);
//            items.push( "<li id='" + key + "'>" + val + "</li>" );
            });       
        })
      });

      $(document).ready(function(){
		$('#previewButton').click(function () {
			socket.emit('java_preview', {url: $('#inputUrl').val(), tableparserClass: $('#tableparser').val()});
			//var enterURL=$('inputUrl').val();
			//alert("Button Clicked:"+$('#inputUrl').val());        	
    	});

		socket.on('warn_existingProcess', function(data){
			alert(data.msg);
		});

    	socket.on('java_preview_complete', function(data){    		
    		var xpath_file=data.xpaths;    		
    		var iframe = document.getElementById('preview');
    		iframe.src=data.page;

    		iframe.addEventListener('load', function(){ //when iframe is loaded, process xpath
    			if(xpath_file!=''){
    				$.getJSON( xpath_file, function( data ) {
          				$.each(data, function( key, val) {
          					//select the element and highlight
          					var theNode = iframe.contentDocument.evaluate(val, iframe.contentDocument,
         						null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
          				
          					theNode.style.borderWidth='5px';
            				theNode.style.borderColor='red';
            				theNode.style.borderStyle = "solid";
           				});       
        			});
    			}
    		});
    	    		
    	});

    	$('#startTaskButton').click(function () {
        document.getElementById('log').innerHTML="<br/>";
    		var email=document.getElementById('inputEmail').value;
    		if(email==null || email==''){
    			alert('Please provide a valid email address. TableMiner+ can take long to complete, you will be notified when it completes.');
    			return false;
    		}

        var iframe = document.getElementById('preview');
      	var selectedNodes = iframe.contentDocument.evaluate("//INPUT[@class='targetTables']", 
      								iframe.contentDocument,
         							null, XPathResult.ORDERED_NODE_ITERATOR_TYPE, null);
      		
      	var selectedTableIndexes='';
      	var index=0;
      	if(selectedNodes!=null){      			
      		var it=selectedNodes.iterateNext();

      		while(it){
      			if(it.checked){
      				selectedTableIndexes+=index+",";          										
      			}
             it=selectedNodes.iterateNext();  
      			index++;
      		}
      	}

      	if(selectedTableIndexes==''){
      		alert('No table is selected, please double check your preview page.');
      		return false;
      	}

			socket.emit('java_sti', 
				{url: $('#inputUrl').val(), 
					tableparserClass: $('#tableparser').val(),
					email:$('#inputEmail').val(),
					tableIndexes:selectedTableIndexes} );

			this.disabled=true;
			document.getElementById('previewButton').disabled=true;
			alert('TableMiner+ has started. Log will be shown in the bottom panel of this page. Please wait until the task is finished before submitting another job. Currently we do not support multi-tasking, which can corrupt the cache used to save remote query results.');
			//var enterURL=$('inputUrl').val();
			//alert("Button Clicked:"+$('#inputUrl').val());        	
    	});

    });

    socket.on('sti_info', function(data){
      var content=document.getElementById('log').innerHTML;
      document.getElementById('log').innerHTML=content+data.msg;
    });
    socket.on('sti_err', function(data){
      var content=document.getElementById('log').innerHTML;
      document.getElementById('log').innerHTML=content+data.msg;
    });
    socket.on('sti_complete', function(data){
      document.getElementById('previewButton').disabled=false;
      document.getElementById('startTaskButton').disabled=false;
      alert("Your task is complete. Visit "+data.msg+" for your output. Thanks for using TableMiner+");
    });
      
      //window.onload=populateTableParserSelect;
</script> <style type="text/css">
#wrapper div#input, iframe {
    float: left;
}
div#log{
	clear:left;
}
iframe#preview { 
  margin-left: 10px;  
  width:100%;
  height:800px;
  max-width:800px;
}
div#input {
  font-family: "Arial";
  max-width: 380px;
  margin-top: auto;
  margin-right: auto;
  margin-bottom: auto;
  margin-left: auto;
  border-top-width: 1px;
  border-right-width: 1px;
  border-bottom-width: 1px;
  border-left-width: 1px;
  border-top-style: solid;
  border-right-style: solid;
  border-bottom-style: solid;
  border-left-style: solid;
  border-top-color: #555e60;
  border-right-color: #555e60;
  border-bottom-color: #555e60;
  border-left-color: #555e60;
  border-radius: 5px;
  background-image: none;
  background-repeat: repeat;
  background-attachment: scroll;
  background-position: 0% 0%;
  padding-top: 0px;
  padding-right: 0px;
  padding-bottom: 0px;
  padding-left: 0px;
}

div#input_banner {
  background-color: #555e60;
}

div.form_div {
  padding-top: 5px;
  padding-right: 5px;
  padding-bottom: 5px;
  padding-left: 5px;
}

#input_header_label {
  font-size: small;
  text-align: right;
  vertical-align: bottom;
  color: white;
}

#input_header {
  vertical-align: bottom;
  color: white;
}

img.icon {
  float: left;
  width: 27px;
  height: 27px;
}

</style></head>
  <body>
    <div id="wrapper">
      <div id="input">
        <div id="input_banner">
          <table style="width: 100%" border="0">
            <tbody>
              <tr>
                <td id="input_header">TableMiner+</td>
                <td id="input_header_label">Define the extraction task</td>
              </tr>
            </tbody>
          </table>
        </div>
        <form accept-charset="utf-8" target="_self" enctype="multipart/form-data"
          autocomplete="off"
          method="POST"
          action="process.jsp"
          name="task">
          <div class="form_div" id="form_url"><img class="icon" alt="" src="resources/icon_url.png">Enter
            a URL containing relational tables<br>
            <input size="38" name="url" id="inputUrl" type="text"><button id="previewButton"
              style="margin-left: 10px"
              type="button">Preview</button>
          </div>
          <div class="form_div" id="form_tableparser"><img class="icon" alt="" src="resources/icon_parser.png">Select
            a table parser<br>
            (To identify relational tables from input files.)&nbsp;
            <select id="tableparser" style="margin-left:25px">
            </select>
          </div>
          <div class="form_div" id="form_email"><img class="icon" alt="" src="resources/icon_email.png">Enter
            an Email address for notification<br>
            <input size="45" name="email" id="inputEmail" required="" type="text">
          </div>
          <div style="margin-left:10px; margin-top:10px;" id="setting_tmp"> <a
              href="">TableMiner+
              settings</a><br>
            <div style="margin-left: 25px; margin-top: 10px; font-size:small;">Advanced
              users only. You may change settings such as feature weights,
              knowledge base query constraints, NLP resources used by the
              system, etc.</div>
          </div>
          <div style="margin-left:10px; margin-top:10px;" id="setting_kbsearch">
            <a href="">Kknowledge base settings</a><br>
            <div style="margin-left: 25px; margin-top: 10px; font-size:small;">Advanced
              users only. You may change configure what knowledge to use, and
              its properties such as access URL, API key etc.</div>
          </div>
          <div style="margin-left:10px; margin-top:10px;" id="setting_websearch">
            <a href="">Web search settings</a><br>
            <div style="margin-left: 25px; margin-top: 10px; font-size:small;">Advanced
              users only. You may configure a Web search instance to be used by TableMiner+ for detecting subject columns.</div>
          </div>
          <div class="form_div" id="form_submit" style="margin-top: 30px"> <button
              style="margin-left: 20px"
              type="reset">Reset</button>
            <button id="startTaskButton" style="margin-left: 20px" type="button">Start</button>
          </div>
        </form>
      </div>
      <iframe id="preview"></iframe> </div>
  </body>
</html>
